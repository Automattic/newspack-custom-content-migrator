<?php

namespace NewspackCustomContentMigrator\Command\PublisherSpecific;

use \NewspackCustomContentMigrator\Command\InterfaceCommand;
use \NewspackCustomContentMigrator\Logic\Posts;
use \NewspackContentConverter\ContentPatcher\ElementManipulators\SquareBracketsElementManipulator;
use \WP_CLI;

/**
 * Custom migration scripts for Diario De Yucatan.
 */
class DiarioDeYucatanMigrator implements InterfaceCommand {

	/**
	 * @var null|InterfaceCommand Instance.
	 */
	private static $instance = null;

	/**
	 * @var Posts Posts instance.
	 */
	private $posts;

	/**
	 * SquareBracketsElementManipulator instance.
	 *
	 * @var SquareBracketsElementManipulator SquareBracketsElementManipulator instance.
	 */
	private $square_brackets_element;

	/**
	 * Constructor.
	 */
	private function __construct() {
		$this->posts = new Posts();
		$this->square_brackets_element = new SquareBracketsElementManipulator();
	}

	/**
	 * Singleton get_instance().
	 *
	 * @return InterfaceCommand|null
	 */
	public static function get_instance() {
		$class = get_called_class();
		if ( null === self::$instance ) {
			self::$instance = new $class;
		}

		return self::$instance;
	}

	/**
	 * See InterfaceCommand::register_commands.
	 */
	public function register_commands() {
		WP_CLI::add_command(
			'newspack-content-migrator diariodeyucatan-migrate-galleriery-shortcodes',
			[ $this, 'cmd_migrate_gallery_shortcodes' ],
		);
	}

	/**
	 * @param array $pos_args
	 * @param array $assoc_args
	 *
	 * @return void
	 */
	public function cmd_migrate_gallery_shortcodes( $pos_args, $assoc_args ) {
		global $wpdb;

		$log_updated = 'yucatanshorts__post_ids_updated.log';
		$log_errors = 'yucatanshorts__ERR.log';

		$post_ids = [ 1653637,1653635,1653647,1653652,1653664,1653667,1653668,1653672,1653674,1653675,1653689,1653690,1653698,1653707,1653710,1653712,1653715,1653717,1653718,1653719,1653721,1653722,1653723,1653724,1653725,1653727,1653728,1653731,1653732,1653733,1653734,1653735,1653737,1653739,1653740,1653741,1653742,1653747,1653748,1653751,1653761,1653773,1653783,1653794,1653796,1653802,1653812,1653817,1653822,1653824,1653826,1653829,1653836,1653838,1653839,1653840,1653842,1653844,1653845,1653850,1653854,1653856,1653857,1653859,1653861,1653868,1653870,1653873,1653876,1653877,1653881,1653884,1653888,1653890,1653892,1653893,1653898,1653908,1653909,1653910,1653911,1653924,1653929,1653933,1653934,1653938,1653940,1653944,1653947,1653950,1653951,1653953,1653963,1653965,1653967,1653970,1653973,1653974,1653975,1653976,1653981,1653984,1653986,1653987,1653988,1653991,1653992,1653994,1654003,1654004,1654006,1654009,1654010,1654014,1654021,1654022,1654025,1654029,1654031,1654033,1654035,1654039,1654044,1654047,1654053,1654059,1654061,1654062,1654064,1654065,1654066,1654067,1654068,1654071,1654072,1654073,1654076,1654077,1654078,1654079,1654080,1654081,1654082,1654083,1654084,1654085,1654086,1654087,1654088,1654089,1654094,1654110,1654113,1654131,1654132,1654133,1654134,1654136,1654137,1654138,1654141,1654144,1654145,1654147,1654150,1654155,1654158,1654160,1654163,1654164,1654167,1654168,1654169,1654171,1654174,1654175,1654177,1654179,1654182,1654183,1654184,1654187,1654190,1654193,1654194,1654197,1654198,1654200,1654203,1654204,1654205,1654207,1654208,1654210,1654213,1654216,1654217,1654218,1654220,1654222,1654223,1654237,1654246,1654256,1654257,1654265,1654275,1654287,1654296,1654297,1654298,1654299,1654300,1654302,1654303,1654305,1654307,1654309,1654314,1654315,1654316,1654318,1654319,1654322,1654323,1654327,1654333,1654336,1654337,1654338,1654340,1654342,1654344,1654348,1654349,1654352,1654360,1654366,1654374,1654377,1654378,1654398,1654399,1654404,1654414,1654416,1654421,1654445,1654450,1654451,1654452,1654463,1654464,1654472,1654473,1654477,1654493,1654495,1654500,1654501,1654502,1654503,1654505,1654506,1654507,1654509,1654515,1654517,1654520,1654521,1654522,1654524,1654526,1654529,1654531,1654532,1654533,1654534,1654537,1654541,1654549,1654550,1654551,1654554,1654555,1654558,1654560,1654563,1654567,1654568,1654569,1654572,1654575,1654576,1654577,1654581,1654582,1654583,1654584,1654586,1654588,1654590,1654592,1654594,1654595,1654596,1654600,1654602,1654603,1654612,1654617,1654619,1654629,1654638,1654642,1654646,1654647,1654652,1654657,1654661,1654668,1654678,1654683,1654684,1654687,1654689,1654690,1654693,1654700,1654702,1654703,1654704,1654708,1654709,1654710,1654713,1654718,1654719,1654723,1654724,1654726,1654727,1654730,1654733,1654736,1654738,1654740,1654741,1654745,1654753,1654755,1654756,1654766,1654769,1654771,1654781,1654803,1654812,1654818,1654821,1654824,1654825,1654829,1654836,1654837,1654842,1654844,1654845,1654846,1654848,1654852,1654855,1654856,1654857,1654860,1654861,1654864,1654865,1654866,1654868,1654871,1654872,1654873,1654876,1654880,1654882,1654885,1654886,1654889,1654891,1654892,1654893,1654894,1654895,1654897,1654902,1654905,1654910,1654918,1654921,1654929,1654933,1654935,1654936,1654940,1654942,1654945,1654946,1654949,1654950,1654952,1654954,1654955,1654956,1654957,1654959,1654960,1654961,1654962,1654964,1654966,1654967,1654969,1654971,1654974,1654975,1654976,1654977,1654978,1654983,1654985,1654988,1654990,1654991,1654992,1654993,1654994,1654997,1654998,1655001,1655002,1655003,1655005,1655010,1655012,1655013,1655017,1655020,1655021,1655027,1655028,1655029,1655030,1655031,1655041,1655049,1655052,1655054,1655055,1655060,1655061,1655062,1655063,1655064,1655065,1655067,1655068,1655072,1655073,1655074,1655077,1655078,1655079,1655082,1655084,1655085,1655086,1655088,1655089,1655092,1655095,1655096,1655102,1655103,1655104,1655107,1655111,1655113,1655120,1655152,1655161,1655162,1655163,1655165,1655167,1655184,1655186,1655188,1655189,1655191,1655193,1655194,1655195,1655201,1655202,1655208,1655210,1655211,1655212,1655213,1655218,1655219,1655226,1655228,1655230,1655231,1655232,1655238,1655246,1655250,1655259,1655264,1655268,1655273,1655275,1655284,1655287,1655290,1655293,1655317,1655319,1655320,1655321,1655322,1655330,1655331,1655334,1655336,1655337,1655339,1655343,1655344,1655346,1655347,1655350,1655351,1655352,1655353,1655355,1655357,1655360,1655361,1655366,1655369,1655370,1655371,1655378,1655382,1655384,1655388,1655391,1655395,1655398,1655399,1655401,1655405,1655420,1655426,1655434,1655449,1655450 ];
		foreach ( $post_ids as $key_post_id => $post_id ) {
			WP_CLI::line( sprintf( "(%d)/(%d) %d", $key_post_id + 1, count( $post_ids ), $post_id ) );

			$post_content = $wpdb->get_var( $wpdb->prepare( "select post_content from {$wpdb->posts} where ID = %d ;", $post_id ) );
			if ( ! $post_content ) {
				continue;
			}

			$post_content_updated = $post_content;
			$shortcode_matches = $this->square_brackets_element->match_shortcode_designations( 'gallery', $post_content_updated );
			if ( empty( $shortcode_matches ) || ! isset( $shortcode_matches[0] ) || empty( $shortcode_matches[0] ) ) {
				continue;
			}

			foreach ( $shortcode_matches as $shortcode_match ) {
				$shortcode = $shortcode_match[0];
				$ids_old_raw = $this->square_brackets_element->get_attribute_value( 'ids', $shortcode );
				$ids_old = array_filter( explode( ',', $ids_old_raw ) );

				$ids_new = [];
				foreach ( $ids_old as $id_old ) {
					$id_new = $wpdb->get_var( $wpdb->prepare( "select post_id from {$wpdb->postmeta} where meta_key = 'newspackcontentdiff_live_id' and meta_value = %d ;", $id_old ) );
					if ( ! $id_new ) {
						$msg = sprintf( 'PostID %d -- id_old %d, new ID not found', $post_id, $id_old );
						file_put_contents( $log_errors, $msg . "\n", FILE_APPEND );
						WP_CLI::warning( $msg );
						continue;
					}
					$ids_new[] = $id_new;
				}

				if ( count( $ids_new ) !== count( $ids_old ) ) {
					$msg = sprintf( 'PostID %d -- miscount ids_old: , ids_new: ', $post_id, implode(',', $ids_old), implode(',', $ids_new) );
					file_put_contents( $log_errors, $msg . "\n", FILE_APPEND );
					WP_CLI::warning( $msg );
					continue;
				}

				$shortcode_updated = str_replace( $ids_old_raw, implode( ',', $ids_new ), $shortcode );
				$post_content_updated = str_replace( $shortcode, $shortcode_updated, $post_content_updated );
			}

			if ( $post_content_updated != $post_content ) {
				$wpdb->update( $wpdb->posts, [ 'post_content' => $post_content_updated ], [ 'ID' => $post_id ] );
				WP_CLI::line( 'UPDATED ' . $post_id );
				file_put_contents( $log_updated, $post_id . "\n", FILE_APPEND );
			}
		}
	}
}
